<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Bizkaibus en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1em;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    input {
      padding: 0.5em;
      font-size: 1em;
      width: 300px;
      max-width: 90vw;
      box-sizing: border-box;
    }
    button {
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
    }
    #map {
      height: 80vh;
      width: 100%;
      max-width: 1750px;
    }
    #login {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
  </style>
</head>
<body>
  <div id="login">
    <h2>Iniciar sesión</h2>
    <input type="text" id="usuario" placeholder="Usuario" />
    <input type="password" id="contrasena" placeholder="Contraseña" />
    <button onclick="verificarLogin()">Entrar</button>
    <p id="error" style="color:red;"></p>
  </div>

  <h1>Localizador de Autobuses Bizkaibus</h1>
  <div id="controls">
    <input type="text" id="linea" placeholder="Introduce nº de línea (ej: A3935 o 3935)" />
    <button onclick="buscarBuses()">Buscar</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // Login simple
    function verificarLogin() {
      const usuario = document.getElementById("usuario").value;
      const contrasena = document.getElementById("contrasena").value;

      // Cambia estas credenciales según necesites
      const USUARIO_CORRECTO = "admin";
      const CONTRASENA_CORRECTA = "1234";

      if (usuario === USUARIO_CORRECTO && contrasena === CONTRASENA_CORRECTA) {
        document.getElementById("login").style.display = "none";
      } else {
        document.getElementById("error").textContent = "Usuario o contraseña incorrectos.";
      }
    }

    // URL de tu hoja publicada como TSV
    const SHEET_TSV_URL =
      "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYeZkna4mwxp3p2azwTgAPcjeSBoUU_rhWW5gVZ7hqotNtojQOHtsjbEnnlJbrijBVwck_kWERE__6/pub?output=tsv";

    let map = L.map("map").setView([43.25, -2.93], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(map);

    let markers = [];
    let paradasMap = new Map();
    let busInfoMap = new Map(); // VehicleRef → { matricula, modelo }

    async function cargarParadas() {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/refs/heads/main/paradas"
        );
        const text = await res.text();
        text.split("\n").forEach(linea => {
          const t = linea.trim();
          if (!t) return;
          const partes = t.split(" - ");
          if (partes.length >= 2) paradasMap.set(partes[0], t);
        });
      } catch (e) {
        console.error("Error cargando paradas:", e);
      }
    }

    async function cargarBusInfo() {
      try {
        const res = await fetch(SHEET_TSV_URL);
        const tsv = await res.text();
        const filas = tsv.trim().split("\n").map(r => r.split("\t"));
        filas.slice(1).forEach(fila => {
          const num = fila[0]?.trim();
          if (num) {
            busInfoMap.set(num, {
              matricula: fila[1]?.trim() || "—",
              modelo: fila[2]?.trim() || "—"
            });
          }
        });
      } catch (e) {
        console.error("Error cargando busInfo:", e);
      }
    }

    function extraerNumero(texto) {
      const m = texto.match(/\d+/);
      return m ? m[0] : null;
    }

    async function buscarBuses() {
      const inputRaw = document.getElementById("linea").value.trim();
      if (!inputRaw) return alert("Introduce un número de línea válido");

      const input = inputRaw.toUpperCase();
      const inputNum = extraerNumero(inputRaw);

      markers.forEach(m => map.removeLayer(m));
      markers = [];

      try {
        const resp = await fetch("https://bizkaibus.onrender.com/bizkaibus");
        const xmlText = await resp.text();
        const xml = new DOMParser().parseFromString(xmlText, "application/xml");
        const actividades = xml.getElementsByTagName("VehicleActivity");
        let encontrados = 0;

        for (let act of actividades) {
          const jref = act.querySelector("VehicleJourneyRef")?.textContent.trim().toUpperCase();
          const vref = act.querySelector("VehicleRef")?.textContent.trim();
          const lat = parseFloat(act.querySelector("Latitude")?.textContent);
          const lon = parseFloat(act.querySelector("Longitude")?.textContent);
          const sp = act.querySelector("StopPointRef")?.textContent.trim();

          if (!jref || !vref || isNaN(lat) || isNaN(lon)) continue;

          const match = jref.match(/A\d{3,4}/);
          const lineaLimpia = match ? match[0] : jref;
          const lineaNum = extraerNumero(lineaLimpia);
          const coincide = (
            lineaLimpia === input ||
            (inputNum && lineaNum === inputNum)
          );
          if (!coincide) continue;

          let paradaTexto = "Parada desconocida";
          if (sp) {
            const numSp = extraerNumero(sp);
            if (numSp && paradasMap.has(numSp)) {
              paradaTexto = paradasMap.get(numSp);
            }
          }

          const infoBus = busInfoMap.get(vref) || { matricula: "—", modelo: "—" };

          const marcador = L.marker([lat, lon]).addTo(map);
          marcador.bindPopup(
            `Bus: ${vref}<br>` +
            `Línea: ${lineaLimpia}<br>` +
            `Parada: ${paradaTexto}<br>` +
            `Matrícula: ${infoBus.matricula}<br>` +
            `Modelo: ${infoBus.modelo}`
          );
          markers.push(marcador);
          encontrados++;
        }

        if (!encontrados) {
          alert("No se encontraron buses para esa línea.");
        } else {
          map.setView(markers[0].getLatLng(), 13);
        }
      } catch (e) {
        console.error("Error en buscarBuses:", e);
        alert("Error al descargar o procesar datos.");
      }
    }

    window.onload = async () => {
      await Promise.all([cargarParadas(), cargarBusInfo()]);
    };
  </script>
</body>
</html>
