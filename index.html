<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buscador de Autobuses Bizkaibus</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; color: #333; }
        .container { background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); max-width: 800px; margin: auto; }
        h1 { color: #005597; }
        label { font-weight: bold; margin-right: 10px; }
        input[type="text"] { padding: 8px; border: 1px solid #ccc; border-radius: 4px; min-width: 150px; margin-bottom: 10px; }
        button {
            padding: 10px 15px;
            background-color: #DA291C; /* Color Bizkaibus */
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        button:hover { background-color: #A81F14; }
        #map { height: 500px; width: 100%; margin-top: 20px; border: 1px solid #ccc; }
        #status { margin-top: 15px; font-style: italic; padding: 10px; border-radius: 4px; }
        .status-error { background-color: #ffebee; color: #c62828; border: 1px solid #c62828; }
        .status-success { background-color: #e8f5e9; color: #2e7d32; border: 1px solid #2e7d32; }
        .status-loading { background-color: #fff9c4; color: #f57f17; border: 1px solid #f57f17; }
    </style>
</head>
<body>

    <div class="container">
        <h1><img src="https://www.bizkaia.eus/documents/10184/0/Escudo+ Diputacion+Foral+de+Bizkaia+-+Koloretan.svg" alt="Escudo Bizkaia" style="height:40px; vertical-align: middle;"> Localizador de Autobuses Bizkaibus</h1>
        <p>Introduce el c√≥digo de la l√≠nea de Bizkaibus (ej: A3136, A3923) y pulsa "Buscar".</p>
        <div>
            <label for="lineaInput">L√≠nea:</label>
            <input type="text" id="lineaInput" placeholder="Ej: A3136">
            <button onclick="buscarAutobuses()">Buscar Autobuses</button>
        </div>
        <div id="status"></div>
        <div id="map"></div>
    </div>

    <script>
        const BIZKAIBUS_XML_URL = 'https://ctb-siri.s3.eu-south-2.amazonaws.com/bizkaibus-vehicle-positions.xml';
        let map;
        let busMarkersLayer;

        // Inicializar el mapa cuando el DOM est√© cargado
        document.addEventListener('DOMContentLoaded', () => {
            // Coordenadas aproximadas del centro de Bizkaia
            map = L.map('map').setView([43.2630, -2.9350], 10); // Bilbao aprox.

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            busMarkersLayer = L.featureGroup().addTo(map); // Capa para gestionar los marcadores
        });

        async function buscarAutobuses() {
            const lineaInput = document.getElementById('lineaInput').value.trim().toUpperCase();
            const statusDiv = document.getElementById('status');

            if (!lineaInput) {
                statusDiv.textContent = 'Por favor, introduce un n√∫mero de l√≠nea.';
                statusDiv.className = 'status-error';
                return;
            }

            statusDiv.textContent = 'Buscando autobuses... ‚è≥';
            statusDiv.className = 'status-loading';
            busMarkersLayer.clearLayers(); // Limpiar marcadores anteriores

            try {
                // Se a√±ade un par√°metro que cambie con el tiempo para intentar evitar problemas de cach√©.
                const response = await fetch(`${BIZKAIBUS_XML_URL}?timestamp=${new Date().getTime()}`, {
                    method: 'GET', // M√©todo expl√≠cito
                    mode: 'cors', // Modo CORS expl√≠cito, aunque el servidor debe permitirlo
                    cache: 'no-cache' // Evitar cach√©
                });

                if (!response.ok) {
                    // Este error se activa si la respuesta HTTP no es exitosa (ej. 404, 500)
                    // OJO: Un bloqueo por CORS a menudo no llega aqu√≠, sino que lanza un NetworkError antes.
                    throw new Error(`Error HTTP al cargar los datos XML: ${response.status} ${response.statusText}`);
                }
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, "application/xml");

                // Comprobar si el XML se parse√≥ correctamente (simple check)
                const parseError = xmlDoc.getElementsByTagName("parsererror");
                if (parseError.length > 0) {
                    console.error("Error al parsear XML:", parseError[0].textContent);
                    throw new Error("El formato del archivo XML recibido no es v√°lido.");
                }

                const vehicleActivities = xmlDoc.getElementsByTagName('VehicleActivity');
                let busesEncontrados = 0;
                const newMarkers = [];

                for (let i = 0; i < vehicleActivities.length; i++) {
                    const activity = vehicleActivities[i];
                    const monitoredJourney = activity.getElementsByTagName('MonitoredVehicleJourney')[0];
                    if (!monitoredJourney) continue;

                    const publishedLineNameTag = monitoredJourney.getElementsByTagName('PublishedLineName')[0];
                    if (!publishedLineNameTag) continue;

                    const currentLine = publishedLineNameTag.textContent.trim().toUpperCase();

                    if (currentLine === lineaInput) {
                        const vehicleLocation = monitoredJourney.getElementsByTagName('VehicleLocation')[0];
                        const vehicleRefTag = monitoredJourney.getElementsByTagName('VehicleRef')[0];
                        const vehicleRef = vehicleRefTag ? vehicleRefTag.textContent : "N/A";

                        if (vehicleLocation) {
                            const latTag = vehicleLocation.getElementsByTagName('Latitude')[0];
                            const lonTag = vehicleLocation.getElementsByTagName('Longitude')[0];

                            if (latTag && lonTag) {
                                const lat = parseFloat(latTag.textContent);
                                const lon = parseFloat(lonTag.textContent);

                                const marker = L.marker([lat, lon]);
                                marker.bindPopup(`<b>L√≠nea: ${currentLine}</b><br>Veh√≠culo: ${vehicleRef}<br>Lat: ${lat.toFixed(5)}, Lon: ${lon.toFixed(5)}`);
                                newMarkers.push(marker);
                                busesEncontrados++;
                            }
                        }
                    }
                }

                if (busesEncontrados > 0) {
                    newMarkers.forEach(marker => busMarkersLayer.addLayer(marker));
                    map.fitBounds(busMarkersLayer.getBounds(), { padding: [50, 50] });
                    statusDiv.textContent = `Se encontraron ${busesEncontrados} autob√∫s(es) para la l√≠nea ${lineaInput}. ‚úÖ`;
                    statusDiv.className = 'status-success';
                } else {
                    statusDiv.textContent = `No se encontraron autobuses para la l√≠nea ${lineaInput} o la l√≠nea no existe en los datos actuales. üôÅ`;
                    statusDiv.className = 'status-error'; // Usamos error para "no encontrado" tambi√©n
                    map.setView([43.2630, -2.9350], 10); // Restablecer vista
                }

            } catch (error) {
                console.error('Error detallado:', error);
                statusDiv.textContent = `Error al procesar la solicitud: ${error.message}. Es muy probable que sea un problema de CORS o de red. Consulta la consola del navegador (F12) para m√°s detalles. ‚ùå`;
                statusDiv.className = 'status-error';
            }
        }
    </script>

</body>
</html>
