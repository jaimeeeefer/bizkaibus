<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Bizkaibus en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1em;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }

    input {
      padding: 0.5em;
      font-size: 1em;
      width: 300px;
      max-width: 90vw;
      box-sizing: border-box;
    }

    button {
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
    }

    #map {
      height: 80vh;
      width: 100%;
      max-width: 2000px;
    }
  </style>
</head>
<body>
  <h1>Localizador de Autobuses Bizkaibus</h1>
  <div id="controls">
    <input type="text" id="linea" placeholder="Introduce nº de línea (ej: A3935)">
    <button onclick="buscarBuses()">Buscar</button>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map('map').setView([43.25, -2.93], 10); // Vizcaya
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap'
    }).addTo(map);

    let markers = [];

    async function buscarBuses() {
      const linea = document.getElementById('linea').value.trim().toUpperCase();
      if (!linea) return alert("Introduce un número de línea válido");

      // Elimina marcadores anteriores
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      try {
        const response = await fetch('https://bizkaibus.onrender.com/bizkaibus');
        if (!response.ok) throw new Error("Error al descargar XML");
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");
        const actividades = xmlDoc.getElementsByTagName("VehicleActivity");

        let encontrados = 0;

        for (let actividad of actividades) {
          const lineaTag = actividad.querySelector("VehicleJourneyRef");
          const vehiculoTag = actividad.querySelector("VehicleRef");
          const latTag = actividad.querySelector("Latitude");
          const lonTag = actividad.querySelector("Longitude");

          if (lineaTag && vehiculoTag && latTag && lonTag) {
            const rawLinea = lineaTag.textContent.trim().toUpperCase();
            const match = rawLinea.match(/A\d{3,4}/);
            const lineaLimpia = match ? match[0] : rawLinea;

            if (lineaLimpia === linea) {
              const lat = parseFloat(latTag.textContent);
              const lon = parseFloat(lonTag.textContent);
              const vehiculo = vehiculoTag.textContent;

              const marker = L.marker([lat, lon]).addTo(map)
                .bindPopup(`Bus: ${vehiculo}<br>Línea: ${lineaLimpia}`);
              markers.push(marker);
              encontrados++;
            }
          }
        }

        if (encontrados === 0) {
          alert("No se encontraron buses para esa línea.");
        } else {
          map.setView(markers[0].getLatLng(), 13);
        }

      } catch (err) {
        console.error(err);
        alert("Error al descargar XML");
      }
    }
  </script>
</body>
</html>
