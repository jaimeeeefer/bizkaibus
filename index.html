<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Bizkaibus en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1em;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #controls {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }
    input {
      padding: 0.5em; font-size: 1em;
      width: 300px; max-width: 90vw; box-sizing: border-box;
    }
    button {
      padding: 0.5em 1em; font-size: 1em; cursor: pointer;
    }
    #map {
      height: 80vh;
      width: 100%; max-width: 1750px;
    }
    #stop-results {
      margin-top: 1em;
      width: 100%;
      max-width: 1750px;
      text-align: left;
    }
    #stop-results h2 {
      margin-top: 0;
    }
    .bus-option {
      background-color: #f0f0f0;
      border: 1px solid #ddd;
      margin-bottom: 0.5em;
      cursor: pointer;
    }
    .bus-option:hover {
      background-color: #e0e0e0;
    }

    #stop-results .bus-option {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.5em;
    }
    #stop-results .bus-option span {
        padding: 0 0.25em; 
        font-weight: normal; 
    }
    #stop-results .bus-option .bus-option-linea {
        flex-basis: 25%; 
        min-width: 100px; 
        text-align: left;
        font-weight: bold;
    }
    #stop-results .bus-option .bus-option-hora {
        flex-basis: 40%; 
        min-width: 150px;
        text-align: center;
        font-weight: bold;
    }
    #stop-results .bus-option .bus-option-destino {
        flex-basis: 35%;
        min-width: 120px;
        text-align: right;
    }

    .delay-text-stop-list {
        font-size: 0.9em;
        font-style: italic;
        margin-left: 5px;
    }
    .delay-text-stop-list.delay { color: #d9534f; }
    .delay-text-stop-list.advance { color: #5cb85c; }
    .delay-text-stop-list.on-time { color: #f0ad4e; }

    #route-details {
      margin-top: 1em;
      width: 100%;
      max-width: 1750px;
      text-align: left;
      border: 1px solid #ccc;
      padding: 1em;
      box-sizing: border-box;
    }
    #route-details ul { list-style-type: none; padding: 0; }
    #route-details li {
      margin-bottom: 0.2em;
      padding: 0.3em;
      border-bottom: 1px dashed #eee;
    }
    #route-details li:last-child { border-bottom: none; }
    .scheduled-time { font-weight: bold; }
    .estimated-time { color: #d9534f; font-style: italic; margin-left: 5px; }
    .waypoint-icon { margin-left: 5px; color: blue; cursor: default; }
  </style>
</head>
<body>
  <h1>Localizador de Autobuses Bizkaibus</h1>
  <div id="controls">
    <input type="text" id="linea" placeholder="Introduce n¬∫ de l√≠nea (ej: A3935 o 3935)" />
    <button onclick="buscarBusesPorLinea()">Buscar L√≠nea</button>
    <input type="text" id="parada" placeholder="Introduce n¬∫ de parada (ej: 123)" />
    <button onclick="buscarBusesPorParada()">Buscar Parada</button>
    <input type="text" id="numBus" placeholder="Introduce n¬∫ de bus (ej: 1514)" />
    <button onclick="buscarBusPorNumero()">Buscar Bus</button>
  </div>
  <div id="stop-results">
    <h2>Pr√≥ximos autobuses en parada:</h2>
    <div id="bus-list"></div>
  </div>
  <div id="route-details" style="display: none;">
    <h2>Detalles del recorrido: <span id="route-line-name"></span></h2>
    <p>Direcci√≥n: <span id="route-headsign"></span></p>
    <p id="delay-info" style="font-weight:bold;"></p>
    <ul id="route-stop-list"></ul>
  </div>
  <div id="map"></div>
  
  <script>
    const USUARIO = "admin";
    const CONTRASENA = "bizkaibus123";
    function autenticar() {
      if (localStorage.getItem("autenticado") === "true") return;
      const u = prompt("Usuario:");
      const p = prompt("Contrase√±a:");
      if (u === USUARIO && p === CONTRASENA) {
        localStorage.setItem("autenticado", "true");
      } else {
        alert("Acceso denegado.");
        document.body.innerHTML = "<h1>401 No autorizado</h1>";
        throw new Error("Acceso denegado");
      }
    }
    autenticar();
  </script>
  
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- URLs y Variables Globales ---
    const SHEET_TSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTYeZkna4mwxp3p2azwTgAPcjeSBoUU_rhWW5gVZ7hqotNtojQOHtsjbEnnlJbrijBVwck_kWERE__6/pub?output=tsv"; 
    const STOPS_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/stops.txt";
    const STOP_TIMES1_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/stop_times1.txt";
    const STOP_TIMES2_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/stop_times2.txt";
    const STOP_TIMES3_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/stop_times3.txt";
    const TRIPS_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/trips.txt";
    const CALENDAR_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/calendar.txt";
    const CALENDAR_DATES_URL = "https://raw.githubusercontent.com/jaimeeeefer/bizkaibusparadas/main/calendar_dates.txt";

    let map = L.map("map").setView([43.25, -2.93], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    let markers = [], stopMarkers = [], realTimeBusMarker = null, linePolylines = [];
    let stopsData = new Map(), busInfoMap = new Map(), stopTimesData = [], tripsData = new Map(), calendarData = new Map(), calendarDatesData = new Map();

    const COLORS = ['#FF0000', '#0000FF', '#008000', '#FFA500', '#800080', '#00FFFF', '#FF00FF', '#808080'];
    const busIcon = L.icon({
        iconUrl: 'https://cdn.rawgit.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
        iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41]
    });
    
    // --- Utilidades de Tiempo ---
    function timeToSeconds(timeStr) {
        if (!timeStr || !/^\d{2}:\d{2}:\d{2}$/.test(timeStr)) return 0;
        const parts = timeStr.split(':');
        return parseInt(parts[0]) * 3600 + parseInt(parts[1]) * 60 + parseInt(parts[2]);
    }
    function secondsToTime(totalSeconds) {
        if (totalSeconds === null || isNaN(totalSeconds)) return "N/A";
        const secondsInDay = 86400;
        let days = Math.floor(totalSeconds / secondsInDay);
        let remainingSeconds = totalSeconds % secondsInDay;
        if (remainingSeconds < 0) {
            remainingSeconds += secondsInDay;
            days -=1; 
        }
        const h = Math.floor(remainingSeconds / 3600).toString().padStart(2, '0');
        const m = Math.floor((remainingSeconds % 3600) / 60).toString().padStart(2, '0');
        const s = (remainingSeconds % 60).toString().padStart(2, '0');
        return `${h}:${m}:${s}${days !== 0 ? ` (${days > 0 ? '+' : ''}${days}d)` : ''}`;
    }

    // --- Funciones Auxiliares ---
    function getCleanStopName(stopId) {
        const stopInfo = stopsData.get(stopId);
        if (stopInfo && stopInfo.stop_name) {
            const name = stopInfo.stop_name;
            const regex = new RegExp(`\\s*\\(${stopId}\\)$`);
            return name.replace(regex, '').replace(/"/g, ''); 
        }
        return "Parada Desconocida";
    }
    function extraerNumero(texto) {
      const m = texto.match(/\d+/);
      return m ? m[0] : null;
    }

    // --- Funciones de Limpieza del Mapa ---
    function clearMapElements() {
        document.getElementById('delay-info').textContent = ''; 
        if (realTimeBusMarker) { map.removeLayer(realTimeBusMarker); realTimeBusMarker = null; }
        linePolylines.forEach(poly => map.removeLayer(poly)); linePolylines = [];
        stopMarkers.forEach(m => map.removeLayer(m)); stopMarkers = [];
    }
    function clearLineSearchMarkers() {
        markers.forEach(m => map.removeLayer(m)); markers = []; 
    }
    
    // --- Funciones de B√∫squeda Principales ---
    async function buscarBusesPorLinea() {
      const inputRaw = document.getElementById("linea").value.trim();
      if (!inputRaw) return alert("Introduce un n√∫mero de l√≠nea v√°lido");

      const input = inputRaw.toUpperCase();
      const inputNum = extraerNumero(inputRaw);

      clearMapElements(); 
      clearLineSearchMarkers(); 

      document.getElementById('stop-results').style.display = 'none';
      document.getElementById('route-details').style.display = 'none';

      try {
        const resp = await fetch("https://bizkaibus.onrender.com/bizkaibus");
        const xmlText = await resp.text();
        const xml = new DOMParser().parseFromString(xmlText, "application/xml");
        const actividades = xml.getElementsByTagName("VehicleActivity");
        let encontrados = 0;
        let bounds = new L.LatLngBounds();

        for (const act of actividades) {
          const jref = act.querySelector("VehicleJourneyRef")?.textContent.trim().toUpperCase();
          const vref = act.querySelector("VehicleRef")?.textContent.trim();
          const lat = parseFloat(act.querySelector("Latitude")?.textContent);
          const lon = parseFloat(act.querySelector("Longitude")?.textContent);
          const sp = act.querySelector("StopPointRef")?.textContent.trim();

          if (!jref || !vref || isNaN(lat) || isNaN(lon)) continue;

          const match = jref.match(/A\d{3,4}/);
          const lineaLimpia = match ? match[0] : jref;
          const lineaNum = extraerNumero(lineaLimpia);
          const coincide = (lineaLimpia === input || (inputNum && lineaNum === inputNum));
          
          if (!coincide) continue;

          const paradaTexto = sp ? getCleanStopName(sp) : "N/D";
          const infoBus = busInfoMap.get(vref) || { matricula: "‚Äî", modelo: "‚Äî", fecha: "‚Äî"};

          const marcador = L.marker([lat, lon]).addTo(map);
          marcador.bindPopup(`<b>L√≠nea:</b> ${lineaLimpia}<br><b>Parada actual/sig.:</b> ${paradaTexto} ${sp ? '('+sp+')' : ''}<br><b>Bus:</b> ${vref}<br><b>Matr√≠cula:</b> ${infoBus.matricula}<br><b>Modelo:</b> ${infoBus.modelo}`);
          markers.push(marcador);
          bounds.extend([lat, lon]);
          encontrados++;
        }

        if (!encontrados) {
          alert("No se encontraron buses en tiempo real para esa l√≠nea.");
        } else if (bounds.isValid()) {
            map.fitBounds(bounds, { padding: [50, 50] });
        }
      } catch (e) {
        console.error("Error en buscarBusesPorLinea:", e);
        alert("Error al descargar o procesar datos de Bizkaibus.");
      }
    }

    async function buscarBusesPorParada() {
        const stopIdInput = document.getElementById("parada").value.trim();
        if (!stopIdInput) return alert("Introduce un n√∫mero de parada v√°lido.");
        const stopId = stopIdInput;
        
        if (!stopsData.has(stopId)) return alert("Parada no encontrada. Introduce un ID de parada v√°lido.");

        clearLineSearchMarkers();
        clearMapElements();  
        document.getElementById('route-details').style.display = 'none';

        const busListDiv = document.getElementById("bus-list");
        busListDiv.innerHTML = "Cargando pr√≥ximos autobuses...";
        document.getElementById('stop-results').style.display = 'block';
        const stopNameForTitle = getCleanStopName(stopId);
        document.getElementById('stop-results').querySelector('h2').textContent = `Pr√≥ximos autobuses en parada: ${stopNameForTitle} (${stopId})`;

        const now = new Date();
        const currentDayOfWeek = now.getDay(); 
        const currentDate = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
        const currentTime = `${now.getHours().toString().padStart(2, '0')}:${now.getMinutes().toString().padStart(2, '0')}:${now.getSeconds().toString().padStart(2, '0')}`;

        const upcomingBuses = [];
        const stopTimesAtThisStop = stopTimesData.filter(st => st.stop_id === stopId);

        for (const st of stopTimesAtThisStop) {
            const trip = tripsData.get(st.trip_id);
            if (!trip) continue;
            const service = calendarData.get(trip.service_id);
            if (!service) continue;
            if (parseInt(currentDate) < parseInt(service.start_date) || parseInt(currentDate) > parseInt(service.end_date)) continue;

            const serviceExceptions = calendarDatesData.get(trip.service_id);
            const currentException = serviceExceptions ? serviceExceptions.get(currentDate) : undefined;
            let runsToday = false;
            if (currentException === 1) runsToday = true;
            else if (currentException === 2) runsToday = false;
            else {
                const dayMap = [service.sunday, service.monday, service.tuesday, service.wednesday, service.thursday, service.friday, service.saturday];
                runsToday = dayMap[currentDayOfWeek] === 1;
            }
            if (runsToday && st.departure_time > currentTime) {
                upcomingBuses.push({ linea: trip.route_id, hora: st.departure_time, destino: trip.trip_headsign, trip_id: st.trip_id, shape_id: trip.shape_id });
            }
        }

        upcomingBuses.sort((a, b) => a.hora.localeCompare(b.hora));
        busListDiv.innerHTML = ""; 

        const realTimeActivities = new Map();
        try {
            const rtResp = await fetch("https://bizkaibus.onrender.com/bizkaibus");
            const rtXmlText = await rtResp.text();
            const rtXml = new DOMParser().parseFromString(rtXmlText, "application/xml");
            // --- CORRECCI√ìN AQU√ç: Usar for...of en lugar de forEach ---
            const rtActivityElements = rtXml.getElementsByTagName("VehicleActivity");
            for (const act of rtActivityElements) {
                const jref = act.querySelector("VehicleJourneyRef")?.textContent.trim();
                if (jref) {
                    realTimeActivities.set(jref, { 
                        stopPointRef: act.querySelector("StopPointRef")?.textContent.trim(), 
                        recordedAtTimeISO: act.querySelector("RecordedAtTime")?.textContent.trim() 
                    });
                }
            }
        } catch (e) { console.warn("No se pudieron obtener datos en tiempo real para estimaciones.", e); }

        if (upcomingBuses.length > 0) {
            const stopInfo = stopsData.get(stopId);
            if (stopInfo) { 
                const stopMarker = L.marker([stopInfo.stop_lat, stopInfo.stop_lon]).addTo(map);
                stopMarker.bindPopup(`<b>Parada:</b> ${getCleanStopName(stopId)} (${stopId})`).openPopup();
                stopMarkers.push(stopMarker); 
                map.setView([stopInfo.stop_lat, stopInfo.stop_lon], 15);
            }

            upcomingBuses.slice(0, 15).forEach(bus => { 
                const busOption = document.createElement("div");
                busOption.classList.add("bus-option");
                let delayStatusText = "";
                if (realTimeActivities.has(bus.trip_id)) {
                    const liveBusData = realTimeActivities.get(bus.trip_id); 
                    const liveBusStopSchedule = stopTimesData.find(st => st.trip_id === bus.trip_id && st.stop_id === liveBusData.stopPointRef);
                    if (liveBusStopSchedule && liveBusData.recordedAtTimeISO) {
                        const scheduledSeconds = timeToSeconds(liveBusStopSchedule.arrival_time);
                        const realTimeDate = new Date(liveBusData.recordedAtTimeISO);
                        const actualSeconds = timeToSeconds(`${realTimeDate.getHours().toString().padStart(2, '0')}:${realTimeDate.getMinutes().toString().padStart(2, '0')}:${realTimeDate.getSeconds().toString().padStart(2, '0')}`);
                        if (scheduledSeconds > 0 && actualSeconds > 0) {
                            const delayMinutes = Math.round((actualSeconds - scheduledSeconds) / 60);
                            if (delayMinutes > 1) delayStatusText = `<span class="delay-text-stop-list delay">(+${delayMinutes}m)</span>`;
                            else if (delayMinutes < -1) delayStatusText = `<span class="delay-text-stop-list advance">(${Math.abs(delayMinutes)}m)</span>`;
                            else if (delayMinutes !== 0) delayStatusText = `<span class="delay-text-stop-list on-time">(${delayMinutes > 0 ? '+' : ''}${delayMinutes}m)</span>`;
                        }
                    }
                }
                busOption.innerHTML = `<span class="bus-option-linea">L√≠nea: ${bus.linea}</span><span class="bus-option-hora">${bus.hora}${delayStatusText}</span><span class="bus-option-destino">Destino: ${bus.destino}</span>`;
                busOption.onclick = () => { mostrarRecorrido(bus.trip_id, bus.shape_id); };
                busListDiv.appendChild(busOption);
            });
        } else {
            busListDiv.innerHTML = `<p>No hay pr√≥ximos autobuses programados para esta parada hoy (${currentTime.substring(0,5)}).</p>`;
        }
    }
    
    // --- L√≥gica Central de Visualizaci√≥n y Tiempo Real ---
    
    async function localizarBusEnTiempoReal(targetTripId = null, targetVehicleRef = null) {
        if (!targetTripId && !targetVehicleRef) return null;
        if (realTimeBusMarker) map.removeLayer(realTimeBusMarker);
        document.getElementById('delay-info').textContent = "Localizando...";

        try {
            const resp = await fetch("https://bizkaibus.onrender.com/bizkaibus");
            const xml = new DOMParser().parseFromString(await resp.text(), "application/xml");
            for (const act of xml.getElementsByTagName("VehicleActivity")) {
                const jref = act.querySelector("VehicleJourneyRef")?.textContent.trim(); 
                const vref = act.querySelector("VehicleRef")?.textContent.trim(); 
                if ((targetTripId && jref === targetTripId) || (targetVehicleRef && vref === targetVehicleRef)) {
                    const lat = parseFloat(act.querySelector("Latitude")?.textContent), lon = parseFloat(act.querySelector("Longitude")?.textContent);
                    if (isNaN(lat) || isNaN(lon)) continue;
                    
                    const spRef = act.querySelector("StopPointRef")?.textContent.trim();
                    const recordedAtTimeISO = act.querySelector("RecordedAtTime")?.textContent.trim();
                    const tripInfo = tripsData.get(jref);
                    realTimeBusMarker = L.marker([lat, lon], { icon: busIcon }).addTo(map);
                    realTimeBusMarker.bindPopup(`<b>¬°Bus en tiempo real!</b><br><b>L√≠nea:</b> ${tripInfo?.route_id || 'N/A'}<br><b>Bus:</b> ${vref}<br><b>En/Cerca de:</b> ${getCleanStopName(spRef)}`).openPopup();
                    
                    let delayInSeconds = null;
                    if (recordedAtTimeISO && spRef && jref) {
                        const tripStopTime = stopTimesData.find(st => st.trip_id === jref && st.stop_id === spRef);
                        if (tripStopTime) {
                            const scheduledSeconds = timeToSeconds(tripStopTime.arrival_time);
                            const realTimeDate = new Date(recordedAtTimeISO);
                            const realTimeSeconds = timeToSeconds(`${realTimeDate.getHours().toString().padStart(2, '0')}:${realTimeDate.getMinutes().toString().padStart(2, '0')}:${realTimeDate.getSeconds().toString().padStart(2, '0')}`);
                            if (scheduledSeconds > 0) delayInSeconds = realTimeSeconds - scheduledSeconds;
                        }
                    }
                    
                    const delayInfoEl = document.getElementById('delay-info');
                    if(delayInSeconds !== null) {
                        const delayMinutes = Math.round(delayInSeconds / 60);
                        if (delayMinutes > 1) { delayInfoEl.textContent = `Retraso estimado: ${delayMinutes} minutos.`; delayInfoEl.style.color = 'red'; } 
                        else if (delayMinutes < -1) { delayInfoEl.textContent = `Adelanto estimado: ${Math.abs(delayMinutes)} minutos.`; delayInfoEl.style.color = 'green'; }
                        else { delayInfoEl.textContent = `En hora (desviaci√≥n < 2 min).`; delayInfoEl.style.color = 'orange'; }
                    } else {
                        delayInfoEl.textContent = 'Posici√≥n localizada, puntualidad no disponible.';
                    }
                    return { tripId: jref, stopId: spRef, delayInSeconds, position: { lat, lon } };
                }
            }
            document.getElementById('delay-info').textContent = 'Autob√∫s no localizado en tiempo real.';
            return null;
        } catch (e) {
            document.getElementById('delay-info').textContent = 'Error obteniendo datos en tiempo real.';
            console.error("Error al localizar el bus en tiempo real:", e);
            return null;
        }
    }

    async function buscarBusPorNumero() {
        const numBus = document.getElementById("numBus").value.trim();
        if (!numBus) return alert("Introduce un n√∫mero de bus v√°lido.");
        clearMapElements(); 
        clearLineSearchMarkers();
        document.getElementById('stop-results').style.display = 'none';
        const busRealTimeData = await localizarBusEnTiempoReal(null, numBus);
        if (busRealTimeData?.tripId) {
            const tripInfo = tripsData.get(busRealTimeData.tripId);
            if (tripInfo) mostrarRecorrido(busRealTimeData.tripId, tripInfo.shape_id, busRealTimeData);
            else { alert(`Se encontr√≥ el bus ${numBus} pero no se pudo cargar su recorrido.`); document.getElementById('route-details').style.display = 'none'; }
        } else {
             document.getElementById('route-details').style.display = 'none'; 
        }
    }

    function renderRouteStopList(stopsOnRoute, delayInSeconds, currentStopId) {
        const routeStopList = document.getElementById('route-stop-list');
        routeStopList.innerHTML = ""; 
        stopsOnRoute.forEach(st => {
            const li = document.createElement("li");
            let estimatedTimeHtml = "";
            if (delayInSeconds !== null) { 
                const scheduledSeconds = timeToSeconds(st.arrival_time);
                if (scheduledSeconds > 0) {
                    estimatedTimeHtml = ` <span class="estimated-time">(Est: ${secondsToTime(scheduledSeconds + delayInSeconds)})</span>`;
                }
            }
            const waypointIconHtml = (currentStopId && st.stop_id === currentStopId) ? ` <span class="waypoint-icon" title="Ubicaci√≥n reportada">üìç</span>` : "";
            li.innerHTML = `<span class="scheduled-time">${st.arrival_time}</span>${estimatedTimeHtml} - ${getCleanStopName(st.stop_id)} (${st.stop_id})${waypointIconHtml}`;  
            routeStopList.appendChild(li);
        });
    }

    async function mostrarRecorrido(tripId, shapeId, busRealTimeData = null) {
        clearLineSearchMarkers();
        clearMapElements();
        document.getElementById('stop-results').style.display = 'none';
        document.getElementById('route-details').style.display = 'block';

        const trip = tripsData.get(tripId);
        if (!trip) {
            alert("Informaci√≥n del viaje no encontrada.");
            document.getElementById('route-details').style.display = 'none';
            return;
        }

        document.getElementById('route-line-name').textContent = trip.route_id;
        document.getElementById('route-headsign').textContent = trip.trip_headsign;
        
        const stopsOnRoute = stopTimesData.filter(st => st.trip_id === tripId).sort((a, b) => a.stop_sequence - b.stop_sequence);

        let liveData = busRealTimeData;
        if (!liveData) liveData = await localizarBusEnTiempoReal(tripId, null);

        renderRouteStopList(stopsOnRoute, liveData?.delayInSeconds, liveData?.stopId);
        
        const mapElementsBounds = new L.LatLngBounds(); 
        const polylinePoints = [];

        stopsOnRoute.forEach(st => {
            const stopInfo = stopsData.get(st.stop_id);
            if (stopInfo) {
                const marker = L.marker([stopInfo.stop_lat, stopInfo.stop_lon]).addTo(map);
                marker.bindPopup(`<b>Parada:</b> ${getCleanStopName(st.stop_id)}<br><b>ID:</b> ${st.stop_id}<br><b>Hora prog.:</b> ${st.arrival_time}`);
                stopMarkers.push(marker);
                polylinePoints.push([stopInfo.stop_lat, stopInfo.stop_lon]);
                mapElementsBounds.extend([stopInfo.stop_lat, stopInfo.stop_lon]);
            }
        });

        if (polylinePoints.length > 0) {
            const color = COLORS[Math.floor(Math.random() * COLORS.length)];
            linePolylines.push(L.polyline(polylinePoints, { color, weight: 5, opacity: 0.7 }).addTo(map));
        }
        
        if (liveData?.position) mapElementsBounds.extend(L.latLng(liveData.position.lat, liveData.position.lon));

        if (mapElementsBounds.isValid()) map.fitBounds(mapElementsBounds, { padding: [70, 70] });
        else if (liveData?.position) map.setView([liveData.position.lat, liveData.position.lon], 15);
    }

    // --- Carga Inicial ---
    async function cargarDatosGTFS() {
        try {
            const resStops = await fetch(STOPS_URL); const textStops = await resStops.text();
            textStops.trim().split("\n").slice(1).forEach(row => {
                const r = row.split(","); 
                if (r[0] && r.length >= 6) {
                    stopsData.set(r[0].trim(), { stop_name: r[2]?.trim(), stop_lat: parseFloat(r[4]), stop_lon: parseFloat(r[5]) });
                }
            });
            const stopTimesTexts = await Promise.all([fetch(STOP_TIMES1_URL).then(res => res.text()), fetch(STOP_TIMES2_URL).then(res => res.text()), fetch(STOP_TIMES3_URL).then(res => res.text())]);
            stopTimesTexts.forEach(text => { text.trim().split("\n").slice(1).forEach(row => { const r = row.split(","); if (r.length >= 5) stopTimesData.push({ trip_id: r[0]?.trim(), arrival_time: r[1]?.trim(), departure_time: r[2]?.trim(), stop_id: r[3]?.trim(), stop_sequence: parseInt(r[4]) }); }); });
            const resTrips = await fetch(TRIPS_URL); const textTrips = await resTrips.text();
            textTrips.trim().split("\n").slice(1).forEach(row => { const r = row.split(","); if (r.length >= 8) tripsData.set(r[2]?.trim(), { route_id: r[0]?.trim(), service_id: r[1]?.trim(), trip_headsign: r[3]?.trim(), shape_id: r[7]?.trim() }); });
            const resCalendar = await fetch(CALENDAR_URL); const textCalendar = await resCalendar.text();
            textCalendar.trim().split("\n").slice(1).forEach(row => { const r = row.split(","); if (r.length >= 10) calendarData.set(r[0].trim(), { monday: parseInt(r[1]), tuesday: parseInt(r[2]), wednesday: parseInt(r[3]), thursday: parseInt(r[4]), friday: parseInt(r[5]), saturday: parseInt(r[6]), sunday: parseInt(r[7]), start_date: r[8]?.trim(), end_date: r[9]?.trim() }); });
            const resCalendarDates = await fetch(CALENDAR_DATES_URL); const textCalendarDates = await resCalendarDates.text();
            textCalendarDates.trim().split("\n").slice(1).forEach(row => { const r = row.split(","); if (r.length >= 3) { const service_id = r[0].trim(); if (!calendarDatesData.has(service_id)) calendarDatesData.set(service_id, new Map()); calendarDatesData.get(service_id).set(r[1].trim(), parseInt(r[2])); } });
            console.log("Carga de datos GTFS completada.");
        } catch (e) { console.error("Error cargando datos GTFS:", e); }
    }
    async function cargarBusInfo() {
        try {
            const res = await fetch(SHEET_TSV_URL); const tsv = await res.text();
            tsv.trim().split("\n").slice(1).forEach(r => { const fila = r.split("\t"); if (fila[0]) busInfoMap.set(fila[0].trim(), { matricula: fila[1]?.trim() || "‚Äî", modelo: fila[2]?.trim() || "‚Äî", fecha: fila[3]?.trim() || "‚Äî" }); });
        } catch (e) { console.error("Error cargando busInfo:", e); }
    }
    window.onload = async () => {
      await Promise.all([cargarBusInfo(), cargarDatosGTFS()]);  
      document.getElementById('stop-results').style.display = 'none';
      document.getElementById('route-details').style.display = 'none';
    };
  </script>
</body>
</html>
