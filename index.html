<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Bizkaibus en Tiempo Real</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 1em;
      margin: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #controls {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 0.5em;
      margin-bottom: 1em;
    }

    input {
      padding: 0.5em;
      font-size: 1em;
      width: 300px;
      max-width: 90vw;
      box-sizing: border-box;
    }

    button {
      padding: 0.5em 1em;
      font-size: 1em;
      cursor: pointer;
    }

    #map {
      height: 80vh;
      width: 100%;
      max-width: 1750px;
    }
  </style>
</head>
<body>
  <h1>Localizador de Autobuses Bizkaibus</h1>
  <div id="controls">
    <input type="text" id="linea" placeholder="Introduce nº de línea (ej: A3935 o 3935)" />
    <button onclick="buscarBuses()">Buscar</button>
  </div>
  <div id="map"></div>

  <script>
    // Autenticación básica por prompt
    const USUARIO = "admin";
    const CONTRASENA = "bizkaibus123";

    function autenticar() {
      const u = prompt("Usuario:");
      const p = prompt("Contraseña:");
      if (u !== USUARIO || p !== CONTRASENA) {
        alert("Acceso denegado.");
        document.body.innerHTML = "<h1>401 No autorizado</h1>";
        throw new Error("Acceso denegado");
      }
    }

    autenticar();
  </script>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let map = L.map("map").setView([43.25, -2.93], 10);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap",
    }).addTo(map);

    let markers = [];
    let paradasMap = new Map();
    let datosBusMap = new Map();

    async function cargarParadas() {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/refs/heads/main/paradas"
        );
        if (!res.ok) throw new Error("Error cargando archivo de paradas");
        const text = await res.text();
        const lineas = text.split("\n");
        lineas.forEach((linea) => {
          const trimmed = linea.trim();
          if (trimmed) {
            const partes = trimmed.split(" - ");
            if (partes.length >= 2) {
              const numero = partes[0];
              paradasMap.set(numero, trimmed);
            }
          }
        });
      } catch (e) {
        console.error(e);
        alert("Error al cargar la lista de paradas.");
      }
    }

    async function cargarDatosBuses() {
      try {
        const res = await fetch(
          "https://raw.githubusercontent.com/jaimeeeefer/bizkaibus/main/datos_buses.tsv"
        );
        if (!res.ok) throw new Error("Error cargando datos de buses");
        const text = await res.text();
        const lineas = text.split("\n");
        lineas.forEach((linea) => {
          const [id, matricula, modelo] = linea.trim().split("\t");
          if (id && matricula && modelo) {
            datosBusMap.set(id, { matricula, modelo });
          }
        });
      } catch (e) {
        console.error(e);
      }
    }

    cargarParadas();
    cargarDatosBuses();

    function extraerNumero(texto) {
      const m = texto.match(/\d+/);
      return m ? m[0] : null;
    }

    async function buscarBuses() {
      const inputRaw = document.getElementById("linea").value.trim();
      if (!inputRaw) return alert("Introduce un número de línea válido");

      const input = inputRaw.toUpperCase();
      const inputNum = extraerNumero(inputRaw);

      markers.forEach((m) => map.removeLayer(m));
      markers = [];

      try {
        const response = await fetch("https://bizkaibus.onrender.com/bizkaibus");
        if (!response.ok) throw new Error("Error al descargar XML");
        const xmlText = await response.text();
        const parser = new DOMParser();
        const xmlDoc = parser.parseFromString(xmlText, "application/xml");
        const actividades = xmlDoc.getElementsByTagName("VehicleActivity");

        let encontrados = 0;

        for (let actividad of actividades) {
          const lineaTag = actividad.querySelector("VehicleJourneyRef");
          const vehiculoTag = actividad.querySelector("VehicleRef");
          const latTag = actividad.querySelector("Latitude");
          const lonTag = actividad.querySelector("Longitude");
          const stopPointTag = actividad.querySelector("StopPointRef");

          if (lineaTag && vehiculoTag && latTag && lonTag) {
            const rawLinea = lineaTag.textContent.trim().toUpperCase();
            const matchLinea = rawLinea.match(/A\d{3,4}/);
            const lineaLimpia = matchLinea ? matchLinea[0] : rawLinea;
            const lineaNum = extraerNumero(lineaLimpia);

            const coincide =
              lineaLimpia === input || (inputNum && lineaNum === inputNum);

            if (coincide) {
              const lat = parseFloat(latTag.textContent);
              const lon = parseFloat(lonTag.textContent);
              const vehiculo = vehiculoTag.textContent;

              let paradaTexto = "Parada desconocida";
              if (stopPointTag) {
                const spId = stopPointTag.textContent.trim();
                const numMatch = spId.match(/\d+/);
                if (numMatch) {
                  const numParada = numMatch[0];
                  if (paradasMap.has(numParada)) {
                    paradaTexto = paradasMap.get(numParada);
                  }
                }
              }

              let extraDatos = "";
              if (datosBusMap.has(vehiculo)) {
                const d = datosBusMap.get(vehiculo);
                extraDatos = `<br>Matrícula: ${d.matricula}<br>Modelo: ${d.modelo}`;
              }

              const marker = L.marker([lat, lon])
                .addTo(map)
                .bindPopup(
                  `Bus: ${vehiculo}<br>Línea: ${lineaLimpia}<br>Parada: ${paradaTexto}${extraDatos}`
                );
              markers.push(marker);
              encontrados++;
            }
          }
        }

        if (encontrados === 0) {
          alert("No se encontraron buses para esa línea.");
        } else {
          map.setView(markers[0].getLatLng(), 13);
        }
      } catch (err) {
        console.error(err);
        alert("Error al descargar XML");
      }
    }

    // Autoactualización cada 30 segundos
    setInterval(() => {
      if (document.getElementById("linea").value.trim()) {
        buscarBuses();
      }
    }, 30000);
  </script>
</body>
</html>
